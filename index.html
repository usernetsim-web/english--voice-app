<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–≥—Ä–∞ —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ä–µ—á–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 2rem;
      background: #f0f0f0;
    }
    #word {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    #status {
      margin: 1rem 0;
      font-weight: bold;
      min-height: 1.2em;
    }
    button {
      font-size: 1.2rem;
      padding: 0.5rem 1rem;
      margin: 0 0.5rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>–ü–µ—Ä–µ–≤–µ–¥–∏ —Å–ª–æ–≤–æ —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π</h1>
  <div id="word">...</div>
  <div id="status"></div>
  <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
  <button id="stopBtn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <script>
    (() => {
      const dictionary = [
        {en: 'apple', ru: ['—è–±–ª–æ–∫–æ', '—è–±–ª–æ—á–∫–æ']},
        {en: 'cat', ru: ['–∫–æ—Ç', '–∫–æ—à–∫–∞', '–∫–æ—Ç–∏–∫']},
        {en: 'dog', ru: ['—Å–æ–±–∞–∫–∞', '–ø—ë—Å', '–ø–µ—Å']},
        {en: 'house', ru: ['–¥–æ–º', '–¥–æ–º–∏–∫']},
        {en: 'car', ru: ['–º–∞—à–∏–Ω–∞', '–∞–≤—Ç–æ–º–æ–±–∏–ª—å']},
        {en: 'book', ru: ['–∫–Ω–∏–≥–∞', '–∫–Ω–∏–∂–∫–∞']},
        {en: 'sun', ru: ['—Å–æ–ª–Ω—Ü–µ']},
        {en: 'water', ru: ['–≤–æ–¥–∞']},
        {en: 'tree', ru: ['–¥–µ—Ä–µ–≤–æ']},
        {en: 'bird', ru: ['–ø—Ç–∏—Ü–∞']},
      ];

      const wordEl = document.getElementById('word');
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');

      let recognition = null;
      let currentIndex = 0;
      let isListening = false;

      // –ê—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–≤—É–∫–æ–≤
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playShot() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = 'square';
        osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
      }

      function explodeWord() {
        playShot();
        statusEl.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ';
        statusEl.style.color = 'green';
      }

      function misfire() {
        statusEl.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë.';
        statusEl.style.color = 'red';
      }

      function showWord() {
        statusEl.textContent = '';
        wordEl.textContent = dictionary[currentIndex].en;
      }

      function checkAnswer(text) {
        if (!text) return false;
        const variants = dictionary[currentIndex].ru;
        const answer = text.toLowerCase().trim();
        return variants.some(v => v.toLowerCase() === answer);
      }

      // –§—É–Ω–∫—Ü–∏—è –æ–∑–≤—É—á–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise –¥–ª—è await
      function sayEnglishWord(text) {
        return new Promise(resolve => {
          if (!window.speechSynthesis) {
            resolve();
            return;
          }
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          utterance.rate = 0.9;
          utterance.onend = resolve;
          window.speechSynthesis.speak(utterance);
        });
      }

      function initRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          statusEl.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.';
          startBtn.disabled = true;
          return null;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recog = new SpeechRecognition();
        recog.lang = 'ru-RU';
        recog.interimResults = false;
        recog.continuous = true;
        recog.maxAlternatives = 1;
        return recog;
      }

      async function onRecognitionResult(event) {
        const transcript = event.results[event.results.length - 1][0].transcript;
        console.log('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', transcript);

        if (checkAnswer(transcript)) {
          explodeWord();
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–∏–Ω—Ç–µ–∑
          recognition.stop();
          isListening = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;

          await sayEnglishWord(dictionary[currentIndex].en);

          // –°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
          currentIndex = (currentIndex + 1) % dictionary.length;
          showWord();

          // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
          recognition.start();
          isListening = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;

          statusEl.textContent = '';
        } else {
          misfire();
        }
      }

      function startListening() {
        if (!recognition) return;
        if (isListening) return;
        recognition.start();
        isListening = true;
        statusEl.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
        startBtn.disabled = true;
        stopBtn.disabled = false;
      }

      function stopListening() {
        if (!recognition) return;
        if (!isListening) return;
        recognition.stop();
        isListening = false;
        statusEl.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function setupRecognition() {
        recognition = initRecognition();
        if (!recognition) return;

        recognition.onresult = onRecognitionResult;

        recognition.onerror = (event) => {
          console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
          if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
            statusEl.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.';
            startBtn.disabled = true;
          }
        };

        recognition.onend = () => {
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —Å–ª—É—à–∞–µ–º
          if (isListening) {
            recognition.start();
          }
        };
      }

      startBtn.addEventListener('click', () => {
        // –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ AudioContext –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ —Å–æ–±—ã—Ç–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
        startListening();
      });

      stopBtn.addEventListener('click', () => {
        stopListening();
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      showWord();
      setupRecognition();
    })();
  </script>
</body>
</html>
